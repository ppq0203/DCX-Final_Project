<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layout/mng/mngSubjectLayout}">

<div layout:fragment="content">
	<div class="row">
		<div class="col-12  p-5">
			<div class="row">
				<div class="col-6">
					<h2>테스트</h2>
				</div>
				<div class="card-tools col-6 text-right">
					<button data-toggle="modal" data-target="#modal-xl" type="button" class="btn btn-primary"
						data-action="create" onclick="changeButtonAction(this)">
						<span>등록</span>
					</button>
				</div>
			</div>
			<!-- /.card-header -->
			<table class="table" id="addrow">
				<thead>
					<tr>
						<th scope="col"></th>
						<th scope="col">날짜</th>
						<th scope="col">과목명</th>
						<th scope="col">강좌명</th>
						<th scope="col">테스트등록</th>
						<th scope="col">테스트시작</th>
						<th scope="col">테스트종료</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th scope="row">1</th>
						<td><button type="button" class="btn btn-link">2023-05-30</button>
						</td>
						<td><span>HTML</span></td>
						<td><span>1</span></td>
						<td>
							<!--<label for="input-file">업로드</label>
								<input type="file" id="input-file" style="display: none;">-->
							<button type="button" class="btn btn-success" data-toggle="modal"
								data-target="#modal-xl">등록</button>
						</td>
						<td>
							<button onclick="javascript:rowDel();" type="button" class="btn btn-danger">시작</button>
						</td>
						<td>
							<button onclick="javascript:rowDel();" type="button" class="btn btn-primary">종료</button>
						</td>
					</tr>
				</tbody>
			</table>
			<!-- /.card-body -->
			<div class="card-footer">
			</div>
		</div>
	</div>
	<!-- Modal -->
	<div class="modal fade" id="modal-xl" style="display: none;" aria-hidden="true">
		<div class="modal-dialog modal-dialog-cented modal-xl">
			<div class="modal-content">
				<div class="col-12 modal-header">
					<div class="col-6">
						<h4 class="col-12 modal-title">시험 등록</h4>
					</div>
					<div class="card-tools col-6 text-right">
						<button onclick="javascript:rowAdd();" type="button" class="btn btn-primary btn-sm">
							<span>추가</span>
						</button>
						<button onclick="javascript:rowDel();" type="button" class="btn btn-danger btn-sm">
							<span>삭제</span>
						</button>
					</div>
				</div>
				<div class="modal-body">
					<div class="container-fluid">
						<div id="qeustionDiv" class="row">

						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
					<button type="button" divn="create" class="btn btn-primary modelBtn" onclick="validation(this)">
						<span>등록</span>
					</button>
					<button type="button" divn="update" class="btn btn-info modelBtn" onclick="validation(this)">
						<span>수정</span>
					</button>
					<button type="button" divn="delete" class="btn btn-danger modelBtn" onclick="validation(this)">
						<span>삭제</span>
					</button>
				</div>
			</div>
		</div>
	</div>
	<script>
		var QUESTION_ARRAY = [];
		function changeButtonAction(button) {
			var action = button.getAttribute("data-action");
			var buttons = document.querySelectorAll("#modal-xl .modal-footer .btn-primary, #modal-xl .modal-footer .btn-info, #modal-xl .modal-footer .btn-danger");
			buttons.forEach(function (btn) {
				btn.style.display = "none"; // 모든 버튼 숨기기
			});
			if (action === "modify") {
				document.querySelector("#modal-xl .modal-footer .btn-info").style.display = "block"; // 수정 버튼 표시
				document.querySelector("#modal-xl .modal-footer .btn-danger").style.display = "block"; // 삭제 버튼 표시
			} else if (action === "create") {
				document.querySelector("#modal-xl .modal-footer .btn-primary").style.display = "block"; // 등록 버튼 표시
			}
		}
		function validation(button) {
			var validate = true;
			$(".validate").each(function () {
				var value = $(this).val();

				// 선택되지 않은 값이나 입력값이 없는 경우 처리
				if (value == "" || value == null || value == '') {
					$(this).addClass("is-invalid");
					validate = false;
				}
			});
			if (!validate) {
				return false;
			} else {

				for (var i = 0; i < QUESTION_ARRAY.length; i++) {
					var formData = new FormData();
					var item = QUESTION_ARRAY[i];
					// 파일 추가
					if (item.file) {
						formData.append('files', item.file);
					} else {
						formData.append('files', new Blob([], {type: 'application/octet-stream'}), 'empty.txt');
					}
					// 기타 필드 추가
					formData.append('titles', new Blob([JSON.stringify(item.title)], {type: "application/json"}));
					formData.append('contents', new Blob([JSON.stringify(item.contents)], {type: "application/json"}));
					// 추가적인 필드가 있다면 여기에 추가해주세요
					$.ajax({
						url: '/mng/exam/create', // 서버의 URL을 입력해주세요
						type: 'POST', // POST 요청으로 전송합니다
						data: formData, // FormData를 전송합니다
						processData: false,
						contentType: false,
						success: function (response) {
							// 요청이 성공적으로 처리되었을 때 실행되는 콜백 함수
							console.log('전송 성공:', response);
							// 전송 후 필요한 작업을 수행해주세요
						},
						error: function (xhr, status, error) {
							// 요청이 실패했을 때 실행되는 콜백 함수
							console.error('전송 실패:', status, error);
							// 실패 시 처리할 작업을 수행해주세요
						}
					});
				}
			}
		}
		function rowAdd() {
			QUESTION_ARRAY.push({});
			arrayInit();
		}
		function rowDel() {
			if (QUESTION_ARRAY.length > 0) {
				QUESTION_ARRAY.pop(); // 배열의 마지막 요소를 삭제합니다.
				arrayInit();
			}
		}
		function arrayInit() {


			$("#qeustionDiv").empty();
			$.each(QUESTION_ARRAY, function (index, item) {
				$("#qeustionDiv").append(
					"<div class=\"col-12\">" +
					"<div class=\"row\">" +
					"<div class=\"col-12 hr\">" +
					"<div class=\"row align-items-center\">" +
					"<div class=\"col-2\">" +
					"<h3 class=\"p-3 num text-center\">" + (index + 1) + "</h3>" +
					"</div>" +
					"<div class=\"col-10\">" +
					"<div class=\"input-group\">" +
					'<input value="' + (item.title === undefined ? '' : item.title) + '" type=\"text\" key=\"title\" index=\"' + index + '\" class=\"form-control questionTitle validate\" placeholder=\"제목\">' +
					"</div>" +
					"</div>" +
					"</div>" +
					"</div>" +
					"<div class=\"col-12\">" +
					"<div class=\"row\">" +
					"<div class=\"col-2\">" +
					"<div class=\"col-sm-12\">" +
					"<img id=\"preview" + index + "\" key=\"src\" index=\"" + index + "\" class=\"card-img-top imgSrc\" data-src=\"holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=Thumbnail\" " +
					"alt=\"Thumbnail [100%x225]\" src=\"" + (item.src === undefined ? "/img/thumbnail.svg" : item.src) + "\" " +
					"data-holder-rendered=\"true\" style=\"height: 10rem; width: 100%; display: block;\">" +
					"</div>" +
					"<div class=\"col-sm-12\">" +
					"<div class=\"custom-file mt-3 mb-3\">" +
					'<input style="display:none;" value="' + (item.file === undefined ? '' : item.file) + '" name=\"imgPath\" key=\"imgPath\" type=\"file\" index=\"' + index + '\" class=\"custom-file-input imgFile\" id=\"customFile' + index + '\">' +
					"<input value=\"" + (item.imgPath === undefined ? '' : item.imgPath) + "\" name=\"imgName\" key=\"imgName\" type=\"hidden\" index=\"" + index + "\" class=\"imgName selected\" id=\"imgName" + index + "\">" +
					"<label class=\"custom-file-label\" for=\"customFile" + index + "\">" +
					'' + (item.imgName === undefined ? '' : item.imgName) + '' +
					"</label>" +
					"</div>" +
					"</div>" +
					"</div>" +
					"<div class=\"col-10\">" +
					"<textarea value=\"" + (item.contents === undefined ? '' : item.contents) + "\" index=\"" + index + "\" key=\"contents\" class=\"form-control form-control-lg questionTestArea validate\" style=\"height: 100%;\" row=\"4\" id=\"validationTextarea\" placeholder=\"문제\">" +
					"" + (item.contents === undefined ? '' : item.contents) + "" +
					"</textarea>" +
					"</div>" +
					"</div>" +
					"</div>" +
					"</div>" +
					"</div>"
				);
			});
			$(".questionTestArea, .questionTitle").change(function () {
				var index = $(this).attr('index');
				var value = $(this).val();
				var key = $(this).attr('key');
				QUESTION_ARRAY[index][key] = value;
			});

			$(".custom-file-input").on("change", function (e) {
				var fileName = $(this).val().split("\\").pop();
				var filePath = $(this).val();
				var index = $(this).attr('index');
				var file = $(this)[0].files[0];
				console.log('파일 : ' + file);
				console.log('파일 경로 : ' + filePath);
				console.log('파일명 : ' + fileName);
				$(this).siblings(this).addClass("selected").html(fileName);
				if (fileName != '') {
					var reader = new FileReader();
					reader.onload = function (event) {
						$('#preview' + index).attr('src', event.target.result);
						QUESTION_ARRAY[index]['src'] = event.target.result;
						QUESTION_ARRAY[index]['imgPath'] = filePath;
						QUESTION_ARRAY[index]['imgName'] = fileName;
						QUESTION_ARRAY[index]['file'] = file;
					};
					reader.readAsDataURL(file);
				}
			});

		}


		$(document).ready(function () {

			$('.modal').on('show.bs.modal', function (e) {
				// 모달이 열릴 때 실행되는 코드
				//$(this).find('form')[0].reset(); // 입력 필드 초기화
				// 테이블 초기화
				QUESTION_ARRAY = [];
				arrayInit();
			});
			$('.modal').on('hidden.bs.modal', function (e) {
				// 모달이 닫힐 때 실행되는 코드
				//$(this).find('form')[0].reset(); // 입력 필드 초기화
				// 테이블 초기화
				QUESTION_ARRAY = [];
				arrayInit();
			});
		});

	</script>
	</th:block>

</html>